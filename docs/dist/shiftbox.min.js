if("undefined"==typeof jQuery)throw new Error("Shiftbox requires jQuery");!function(a){"use strict";function b(){return a(a(document).data(d.DATA_GLOBAL_MODAL)).data(d.DATA_CURRENT)}function c(b){return this.each(function(){var c=a(this),e=c.data(d.DATA_PLUGIN),f="object"==typeof b&&b;e||c.data(d.DATA_PLUGIN,e=new d(this,f)),("string"==typeof b||b instanceof String)&&e[b].call(c)})}var d=function(b,c){var e=this;e.$element=a(b),e.options=a.extend({},d.DEFAULTS,c),e.initGallery(),e.$element.on("click",function(a){return!e.modalOpened&&void e.open(a)}),e.createModal(),e.current={},e.modalOpened=!1,e.zoomState=!1};d.DEFAULTS={loadingText:"Loading...",errorText:"Preview not available",zoomSwitch:!0,zoomSwitchSelector:"#shiftbox-zoom-switch",modalSelector:"#shiftbox-modal",modalAttachSelector:"body",modalLayout:'<div class="modal fade" tabindex="-1" role="dialog" id="shiftbox-modal"><div class="modal-dialog"><div class="modal-content" style="overflow:hidden"><div class="modal-body" style="padding:0"><div id="shiftbox-picture"></div><div id="shiftbox-button-prev"><img src="/images/shiftbox/prev.png"></div><div id="shiftbox-button-next"><img src="/images/shiftbox/next.png"></div><div id="shiftbox-zoom-switch"><img src="/images/shiftbox/zoom.png"></div><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div></div></div></div>',prevBtnSelector:"#shiftbox-button-prev",nextBtnSelector:"#shiftbox-button-next",pictureSelector:"#shiftbox-picture"},d.DATA_PLUGIN="shiftbox",d.DATA_CURRENT="shiftbox-current",d.DATA_GALLERY="gallery",d.DATA_GLOBAL_GALLERY="shiftbox-gallery",d.DATA_GLOBAL_MODAL="shiftbox-modal",d.prototype.createModal=function(){var c=this,e=a(c.options.modalLayout);"undefined"==typeof c.$modal&&(0===a(c.options.modalSelector).length?(a(c.options.modalAttachSelector).prepend(e),a(document).data(d.DATA_GLOBAL_MODAL,c.options.modalSelector)):e=a(c.options.modalSelector).first(),c.buttons={prev:e.find(c.options.prevBtnSelector).first(),next:e.find(c.options.nextBtnSelector).first(),zoomSwitch:e.find(c.options.zoomSwitchSelector).first()},c.buttons.prev.off("click").on("click",function(){b().prev()}),c.buttons.next.off("click").on("click",function(){b().next()}),c.buttons.zoomSwitch.off("click").on("click",function(){b().zoomSwitch()}),e.on("shown.bs.modal",function(){b().modalOpened=!0}).on("hide.bs.modal",function(){b().modalOpened=!1}),a(window).on("resize",function(){b().modalOpened&&b().fitModal()}),c.$modal=e)},d.prototype.resetModal=function(){var a=this;"undefined"!=typeof a.$modal&&(a.$modal.find(".modal-dialog").removeAttr("style"),a.$modal.find(".modal-content").removeAttr("style").css("overflow","hidden"),a.$modal.find(a.options.pictureSelector).html("").removeAttr("style"))},d.prototype.open=function(b){var c=this,e=a(document).data(d.DATA_GLOBAL_GALLERY),f=c.gallery;if("object"==typeof b&&"function"==typeof b.preventDefault&&b.preventDefault(),f)for(var g=0;g<e[f].list.length;g++)if(e[f].list[g]===c.$element.attr("href")){e[f].index=g;break}c.checkButtons(),c.options.zoomSwitch?c.$modal.find(c.options.zoomSwitchSelector).show():c.$modal.find(c.options.zoomSwitchSelector).hide(),c.$modal.data(d.DATA_CURRENT,c),c.$modal.modal("show"),c.loadImage(c.$element.attr("href"))},d.prototype.fitModal=function(){var b=this,c=b.getViewport();if(b.current.modalHeight=Math.max(c.height-60,320),b.current.modalWidth=parseInt(.9*c.width)>b.current.baseImg.naturalWidth?b.current.baseImg.naturalWidth:parseInt(.9*c.width),b.current.$baseImg.css({maxWidth:b.zoomState?"unset":b.current.modalWidth,maxHeight:b.zoomState?"unset":b.current.modalHeight,left:b.zoomState?0:"auto",top:0,position:b.zoomState?"absolute":"static",textAlign:b.zoomState?"unset":"center"}),b.current.$picture.html(b.current.$baseImg),b.current.modalHeight=Math.min(b.current.modalHeight,b.current.baseImg.naturalHeight),b.$modal.find(".modal-dialog").css("width",b.current.modalWidth),b.$modal.find(".modal-content").css("height",b.current.modalHeight),!b.zoomState){var d=b.current.modalWidth/b.current.modalHeight,e=b.current.baseImg.naturalWidth/b.current.baseImg.naturalHeight;d<e?b.$modal.find(".modal-content").css("height",b.current.modalWidth/e):b.$modal.find(".modal-dialog").css("width",b.current.modalHeight*e)}b.current.$picture.data("modal-width",b.$modal.find(".modal-dialog").width()).data("modal-height",b.$modal.find(".modal-content").height()).data("picture-width",b.current.baseImg.naturalWidth).data("picture-height",b.current.baseImg.naturalHeight).off("mousemove").on("mousemove",function(a){b.shiftOnMouse(a)}).off("touchstart").on("touchstart",function(a){a.preventDefault()}).off("touchmove").on("touchmove",function(c){var d=c.originalEvent.touches[0]||c.originalEvent.changedTouches[0],e=a(this),f=e.offset();c.pageX=d.pageX-f.left,c.pageY=d.pageY-f.top,c.preventDefault(),c.pageX<e.width()&&c.pageX>0&&c.pageY<e.height()&&c.pageY>0&&b.shiftOnMouse(c)}).css({width:b.current.$picture.data("modal-width"),height:b.current.$picture.data("modal-height")})},d.prototype.getViewport=function(){return{width:Math.max(document.documentElement.clientWidth,window.innerWidth||0),height:Math.max(document.documentElement.clientHeight,window.innerHeight||0)}},d.prototype.loadImage=function(b){var c=this;c.current.$picture=c.$modal.find(c.options.pictureSelector),c.current.baseImg=new Image,c.current.$baseImg=a(c.current.baseImg),c.zoomState=!1,c.current.baseImg.onload=function(){c.fitModal()},c.current.baseImg.onerror=function(){c.resetModal(),c.current.$picture.html('<p class="shiftbox-error">'+c.options.errorText+"</p>")},c.current.$picture.html('<p class="shiftbox-message">'+c.options.loadingText+"</p>"),c.current.baseImg.src=b},d.prototype.initGallery=function(){var b=this,c=b.$element.data(d.DATA_GALLERY),e=a(document).data(d.DATA_GLOBAL_GALLERY)?a(document).data(d.DATA_GLOBAL_GALLERY):{};if(c){e[c]={index:0,list:[]},b.gallery=c,a("[data-"+d.DATA_GALLERY+'="'+c+'"]').each(function(){a(this).attr("href")&&e[c].list.push(a(this).attr("href"))});for(var f=0;f<e[c].list.length;f++)if(e[c].list[f]===b.$element.attr("href")){e[c].index=f;break}}a(document).data(d.DATA_GLOBAL_GALLERY,e)},d.prototype.prev=function(){var b=this;if(b.gallery){var c=b.gallery,e=a(document).data(d.DATA_GLOBAL_GALLERY);e[c].index>0?e[c].index--:e[c].index=0,b.checkButtons(),b.loadImage(e[c].list[e[c].index])}},d.prototype.next=function(){var b=this;if(b.gallery){var c=b.gallery,e=a(document).data(d.DATA_GLOBAL_GALLERY);e[c].index<e[c].list.length-1?e[c].index++:e[c].index=e[c].list.length,b.checkButtons(),b.loadImage(e[c].list[e[c].index])}},d.prototype.zoomSwitch=function(){var a=this;a.zoomState=!a.zoomState,a.fitModal()},d.prototype.checkButtons=function(){var b=this,c=a(document).data(d.DATA_GLOBAL_GALLERY);if(b.gallery){var e=b.gallery;c[e].index>0?b.buttons.prev.show():b.buttons.prev.hide(),c[e].index<c[e].list.length-1?b.buttons.next.show():b.buttons.next.hide()}else b.buttons.next.hide(),b.buttons.prev.hide()},d.prototype.close=function(a){var b=this;b.$modal.modal("hide"),a&&a.preventDefault()},d.prototype.shiftOnMouse=function(b){var c=this;if(c.zoomState){var d=c.current.$picture.data("picture-width")>c.current.$picture.data("modal-width"),e=c.current.$picture.data("picture-height")>a(window).height()-60,f=b.pageX,g=b.pageY;"touchmove"!==b.originalEvent.type&&(f-=c.current.$picture.offset().left,g-=c.current.$picture.offset().top),d&&c.current.$picture.find("img").css("left",-parseInt(f*c.current.$picture.data("picture-width")/c.current.$picture.data("modal-width"))+f),e&&c.current.$picture.find("img").css("top",-parseInt(g*c.current.$picture.data("picture-height")/c.current.$picture.data("modal-height"))+g)}},d.prototype.destroy=function(){var b=this,c=a(this);b.$modal&&b.$modal.remove(),c.data(d.DATA_PLUGIN,void 0),b.prototype.open=function(){}},a.fn.shiftbox=c,a.fn.shiftbox.Constructor=d}(jQuery);